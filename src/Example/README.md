# Converting Extract C Code From Lean to Wasm: The Right Way v.s. The Wrong Way 
**Assumptions**: 

1. you have [wabt](https://github.com/WebAssembly/wabt) installed and wasm2wat available.
2. you have [elan](https://github.com/leanprover/elan) installed and set $home/.elan/toolchains/leanprover--lean4---v4.17.0 as sysroot

The right way: use clang generated wasm file

The wrong way: use lean compiler generated wasm file 


## Two Ways to Generate Wasm/Wat Files

### Fisrt Way
1. We can use clang with the following flags, library file linkers,  and sysroot steup. Btw, 
$home is the directory where you have .elan stored. In our case, it's /Users/sallywang. 

   ```
   -target wasm32-unknown-emscripten -fignore-exceptions -mllvm -combiner-global-alias-analysis=false -mllvm -enable-emscripten-sjlj -mllvm -disable-lsr
   --sysroot=$home/.elan/toolchains/leanprover--lean4---v4.17.0  -DEMSCRIPTEN -Xclang -iwithsysroot/include/fakesdl -Xclang -iwithsysroot/include/compat
   -I $home/.elan/toolchains/leanprover--lean4---v4.17.0/lib $home/.elan/toolchains/leanprover--lean4---v4.17.0/include
   ```

For example, to obtain wasm file of [example.c](https://github.com/sallywang147/LeanFunFix/tree/main/src/Example) and corresponding [example.lean](https://github.com/sallywang147/LeanFunFix/blob/main/src/Example/example.lean) in this Example folder on my machine,
you can use the following command (you need to replace /Users/sallywang with your own path): 

```
clang -target wasm32-unknown-emscripten -fignore-exceptions -mllvm -combiner-global-alias-analysis=false -mllvm -enable-emscripten-sjlj -mllvm -disable-lsr
--sysroot=/Users/sallywang/.elan/toolchains/leanprover--lean4---v4.17.0  -DEMSCRIPTEN -Xclang -iwithsysroot/include/fakesdl -Xclang -iwithsysroot/include/compat
-I /Users/sallywang/.elan/toolchains/leanprover--lean4---v4.17.0/lib /Users/sallywang/.elan/toolchains/leanprover--lean4---v4.17.0/include -c example.c -o example.wasm
```
The command above will generate a binary wasm file [example.wasm](https://github.com/sallywang147/LeanFunFix/blob/main/src/Example/example.wasm). Then you can run the following command to convert the binary file to text: 
```
/home/sally/wabt/bin/wasm2wat example.wasm -o example.wat
```
Then we will have the wasm file in text format in [example.wat](https://github.com/sallywang147/LeanFunFix/blob/main/src/Example/example.wat). Noow we can analyze instructions, jumps, blocks etc (yay!) 

### Second Way
2. We can also use lean (also lake build system by extension) to generate wasm binary file:

```
leanc example.c -o example.wasm
```
I consider it the wrong way, because the wasm file generated by leanc cannot be converted to the text format by wabt easily. Instead, you will likely observe some weird magic value error like below: 

<img width="291" alt="Screen Shot 2025-03-19 at 4 00 10 AM" src="https://github.com/user-attachments/assets/0ee68603-3503-4fde-8f98-c839516f67d9" />

That error occurs, likely due to incompatibility between leanc compiler version and the default clang on a machine/wabt uses. Given the error, the second way to generate wasm is NOT recommended. 
